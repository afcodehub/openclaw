services:
  gateway:
    image: openclaw-local:test
    build:
      context: .
      args:
        - CLAWDBOT_DOCKER_APT_PACKAGES=python3 curl
    user: "0:0"
    ports:
      - "18789:18789"
    environment:
      - HOME=/home/node #Define o diret√≥rio home do usu√°rio node
      - TERM=xterm-256color #Define o terminal como xterm-256color
      - CLAWDBOT_GATEWAY_TOKEN=sua_chave_de_api_do_gateway #Define o token de autentica√ß√£o do gateway
      - CLAWDBOT_GATEWAY_PORT=18789 #Define a porta do gateway
      - CLAWDBOT_BRIDGE_PORT=18790 #Define a porta da bridge
      - CLAWDBOT_GATEWAY_BIND=lan #Define o bind do gateway
      - CLAWDBOT_GATEWAY_TRUSTED_PROXIES=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,10.0.1.13 #Proxies confi√°veis
      - CLAWDBOT_LOG_LEVEL=debug #N√≠vel de log do gateway
      # ============================================
      # --- Configura√ß√£o de Chaves de IA ---
      # ============================================
      - OPENAI_API_KEY=sua_chave_de_api_da_openai #Sua chave de API da OpenAI
      - OPENAI_MODEL=gpt-4o-mini #Modelo principal da OpenAI (ex: gpt-4o, gpt-4-turbo, gpt-4o-mini)
      - GEMINI_API_KEY=sua_chave_de_api_do_gemini #Sua chave de API do Gemini
      - ANTHROPIC_API_KEY=sua_chave_de_api_da_anthropic #Sua chave de API da Anthropic
      - BRAVE_API_KEY=sua_chave_de_api_da_brave #Sua chave de API da Brave
      # ============================================
      # --- Whitelist de Dom√≠nios ---
      # ============================================
      # Restringe o acesso do agente a apenas sites/dom√≠nios autorizados
      # Use '*' para permitir todos ou liste dom√≠nios separados por v√≠rgula (ex: google.com,github.com,stackoverflow.com)
      - ALLOWED_DOMAINS=* #Dom√≠nios permitidos para navega√ß√£o, busca e fetch - Deixe * para todos
      # ============================================
      # --- Configura√ß√£o de TTS ---
      # ============================================
      - TTS_AUTO_MODE=off #Define se o bot envia √°udio automaticamente ("off"|"always"|"inbound"|"tagged)
      - ELEVENLABS_API_KEY=sua_chave_de_api_da_elevenlabs #Sua chave de API da ElevenLabs
      # ============================================
      # --- Configura√ß√£o Telegram ---
      # ============================================
      - TELEGRAM_BOT_TOKEN=sua_chave_de_api_do_telegram #Token do bot obtido via @BotFather (ex: 123456789:ABCdefGHIjklMNOpqrSTUvwxYZ)
      - TELEGRAM_ALLOWED_USERS=seu_id_de_usuario_telegram #IDs de usu√°rios permitidos - Deixe * para permitir todos (ex: 123456789,987654321)
      - TELEGRAM_DM_POLICY=allowlist #Pol√≠tica de DMs: disabled=Bloqueia todas, allowlist=Permite apenas IDs autorizados
      - TELEGRAM_GROUP_POLICY=allowlist #Pol√≠tica de grupos: disabled=Ignora grupos, allowlist=Permite apenas grupos autorizados
      - TELEGRAM_ALLOWED_GROUPS= #IDs de grupos permitidos - Deixe * para permitir todos
      - TELEGRAM_HISTORY_LIMIT=50 #Limite de mensagens para contexto em grupos
      - TELEGRAM_DM_HISTORY_LIMIT=10 #Limite de mensagens de contexto em DMs
      - TELEGRAM_MEDIA_MAX_MB=50 #Limite de tamanho para download de m√≠dias recebidas
      - TELEGRAM_TEXT_CHUNK_LIMIT=4096 #Limite de caracteres por mensagem enviada (m√°ximo do Telegram)
      - TELEGRAM_CONFIG_WRITES=true #Permite ou bloqueia altera√ß√£o de config via comandos no Telegram
      - TELEGRAM_MESSAGE_PREFIX= #Prefixo nas mensagens enviadas pelo bot
      # ============================================
      # --- Configura√ß√£o WhatsApp ---
      # ============================================
      - WHATSAPP_ALLOWED_NUMBER=seu_numero_de_telefone #N√∫mero de telefone autorizado a usar o bot  - Deixe * para permitir todos
      - WHATSAPP_DM_POLICY=allowlist #Pol√≠tica de DMs: disabled=Bloqueia todas, allowlist=Permite apenas n√∫meros autorizados
      - WHATSAPP_SELF_CHAT=false #Define se o bot deve responder a si mesmo (√∫til para testes no pr√≥prio n√∫mero)
      - WHATSAPP_READ_RECEIPTS=true #Define se o bot deve enviar confirma√ß√£o de leitura
      - WHATSAPP_ACK_EMOJI=üëÄ #Define o emoji que o bot deve usar para confirmar leitura
      - WHATSAPP_GROUP_POLICY=allowlist #Define se o bot deve responder em grupos
      - WHATSAPP_ACTIVATION=mention #Define se o bot responde a tudo no grupo (always) ou apenas quando mencionado (mention)
      - WHATSAPP_HISTORY_LIMIT=50 #Limite de mensagens para contexto em grupos
      - WHATSAPP_MEDIA_MAX_MB=50 #Limite de tamanho para download de m√≠dias recebidas
      - WHATSAPP_TEXT_CHUNK_LIMIT=4000 #Limite de caracteres por mensagem enviada
      - WHATSAPP_CONFIG_WRITES=true #Permite ou bloqueia altera√ß√£o de config via comandos no WhatsApp
      - WHATSAPP_MESSAGE_PREFIX= #Prefixo nas mensagens enviadas pelo bot
      - WHATSAPP_INBOUND_PREFIX= #Prefixo nas mensagens recebidas pelo bot (visto pela IA)
      - WHATSAPP_CHUNK_MODE=newline #Modo de divis√£o de mensagens longas
      - WHATSAPP_DM_HISTORY_LIMIT=10 #Limite de mensagens de contexto em DMs
      - WHATSAPP_ALLOW_REACTIONS=true #Permite que o bot use a ferramenta de rea√ß√£o
      # ============================================
      # --- Configura√ß√µes Gerais ---
      # ============================================
      - WEB_HEARTBEAT_SECONDS=60 #Frequ√™ncia de verifica√ß√£o da conex√£o (segundos)
      # ============================================
      # --- Configura√ß√µes de Conex√£o WhatsApp ---
      # ============================================
      # ‚ö†Ô∏è IMPORTANTE: Valores alinhados com Whaileys defaults para m√°xima estabilidade
      - CLAWDBOT_WA_CONNECT_TIMEOUT=20000 #Timeout de conex√£o WebSocket (20s - Whaileys default)
      - CLAWDBOT_WA_QUERY_TIMEOUT=60000 #Timeout de queries ao WhatsApp (60s - Whaileys default)
      - CLAWDBOT_WA_QR_TIMEOUT=60000 #Timeout do QR Code (60s)
      - CLAWDBOT_WA_KEEPALIVE=15000 #Keep-alive cr√≠tico (15s - Whaileys default) ‚ö†Ô∏è N√ÉO AUMENTAR
      - CLAWDBOT_WA_RETRY_DELAY=250 #Delay entre retries (250ms - Whaileys default) - Reconex√£o r√°pida
      # ============================================
      # --- Navegador Simulado (Anti-Ban) ---
      # ============================================
      - CLAWDBOT_BROWSER_OS=Mac OS #Define o sistema operacional do navegador simulado
      - CLAWDBOT_BROWSER_NAME=Chrome #Define o nome do navegador simulado
      - CLAWDBOT_BROWSER_VERSION=121.0.6167.85 #Define a vers√£o do navegador simulado
    volumes:
      - moltbot_config:/home/node/.openclaw
      - moltbot_workspace:/home/node/clawd
    command:
      - /bin/sh
      - -c
      - |
        mkdir -p /home/node/.openclaw
        if [ ! -f /home/node/.openclaw/openclaw.json ]; then
          echo "‚ö†Ô∏è  openclaw.json n√£o encontrado. Criando arquivo com valores padr√£o..."
          # Gera o JSON de configura√ß√£o apenas se n√£o existir
          cat <<EOF > /home/node/.openclaw/openclaw.json
        {
          "gateway": {
            "mode": "local",
            "controlUi": { "allowInsecureAuth": true }
          },
          "web": {
            "heartbeatSeconds": $${WEB_HEARTBEAT_SECONDS},
            "reconnect": {
              "initialMs": 1000,
              "maxMs": 60000,
              "factor": 2.0,
              "jitter": 0.1,
              "maxAttempts": 20
            }
          },
          "commands": {
            "bash": true,
            "config": true
          },
          "agents": {
            "list": [
              { 
                "id": "main", 
                "name": "Moltbot", 
                "model": "openai/$${OPENAI_MODEL}",
                "tools": {
                  "profile": "full",
                  "allow": ["weather", "openai-whisper-api", "openai-image-gen"]
                }
              }
            ]
          },
          "models": {
            "providers": {
              "openai": {
                "baseUrl": "https://api.openai.com/v1",
                "apiKey": "$${OPENAI_API_KEY}",
                "models": [{ "id": "$${OPENAI_MODEL}", "name": "OpenAI Model" }]
              },
              "google": {
                "baseUrl": "https://generativelanguage.googleapis.com/v1beta",
                "apiKey": "$${GEMINI_API_KEY}",
                "models": [{ "id": "gemini-3-flash-preview", "name": "Gemini 3 Flash" }]
              },
              "anthropic": {
                "baseUrl": "https://api.anthropic.com/v1",
                "apiKey": "$${ANTHROPIC_API_KEY}",
                "models": [{ "id": "claude-haiku-4-5-20251001", "name": "Claude Haiku 4.5" }]
              }
            }
          },
          "tools": {
            "web": {
              "search": {
                "provider": "brave",
                "apiKey": "$${BRAVE_API_KEY}"
              }
            },
            "media": {
              "audio": {
                "enabled": true,
                "models": [
                  { "provider": "openai", "model": "whisper-1" }
                ]
              }
            }
          },
          "messages": {
            "responsePrefix": "$${TELEGRAM_MESSAGE_PREFIX}",
            "tts": {
              "provider": "openai",
              "auto": "$${TTS_AUTO_MODE}"
            }
          },
          "usage": {
            "dailyLimit": {
              "enabled": true,
              "maxDailyCostUsd": 0.002,
              "warningThreshold": 50
            }
          },
          "channels": {
            "telegram": {
              "enabled": true,
              "botToken": "$${TELEGRAM_BOT_TOKEN}",
              "dmPolicy": "$${TELEGRAM_DM_POLICY}",
              "allowFrom": ["$${TELEGRAM_ALLOWED_USERS}"],
              "groupPolicy": "$${TELEGRAM_GROUP_POLICY}",
              "groupAllowFrom": ["$${TELEGRAM_ALLOWED_GROUPS}"],
              "historyLimit": $${TELEGRAM_HISTORY_LIMIT},
              "dmHistoryLimit": $${TELEGRAM_DM_HISTORY_LIMIT},
              "mediaMaxMb": $${TELEGRAM_MEDIA_MAX_MB},
              "textChunkLimit": $${TELEGRAM_TEXT_CHUNK_LIMIT},
              "configWrites": $${TELEGRAM_CONFIG_WRITES}
            },
            "whatsapp": {
              "accounts": {
                "default": {
                  "name": "Moltbot",
                  "enabled": true,
                  "selfChatMode": $${WHATSAPP_SELF_CHAT},
                  "sendReadReceipts": $${WHATSAPP_READ_RECEIPTS},
                  "dmPolicy": "$${WHATSAPP_DM_POLICY}",
                  "allowFrom": ["$${WHATSAPP_ALLOWED_NUMBER}"],
                  "groupPolicy": "$${WHATSAPP_GROUP_POLICY}",
                  "ackReaction": {
                    "emoji": "$${WHATSAPP_ACK_EMOJI}",
                    "direct": true,
                    "group": "mentions"
                  }
                }
              },
              "dmPolicy": "$${WHATSAPP_DM_POLICY}",
              "allowFrom": ["$${WHATSAPP_ALLOWED_NUMBER}"],
              "selfChatMode": $${WHATSAPP_SELF_CHAT},
              "sendReadReceipts": $${WHATSAPP_READ_RECEIPTS},
              "groupPolicy": "$${WHATSAPP_GROUP_POLICY}",
              "historyLimit": $${WHATSAPP_HISTORY_LIMIT},
              "mediaMaxMb": $${WHATSAPP_MEDIA_MAX_MB},
              "textChunkLimit": $${WHATSAPP_TEXT_CHUNK_LIMIT},
              "chunkMode": "$${WHATSAPP_CHUNK_MODE}",
              "dmHistoryLimit": $${WHATSAPP_DM_HISTORY_LIMIT},
              "messagePrefix": "$${WHATSAPP_INBOUND_PREFIX}",
              "configWrites": $${WHATSAPP_CONFIG_WRITES},
              "actions": {
                "reactions": $${WHATSAPP_ALLOW_REACTIONS}
              },
              "ackReaction": {
                "emoji": "$${WHATSAPP_ACK_EMOJI}",
                "direct": true,
                "group": "mentions"
              }
            }
          }
        }
        EOF
          echo "‚úÖ  Arquivo openclaw.json criado com sucesso!"
        else
          echo "‚ÑπÔ∏è  Arquivo openclaw.json j√° existe. Mantendo configura√ß√£o atual."
        fi
        exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured --verbose

volumes:
  moltbot_config:
  moltbot_workspace:
